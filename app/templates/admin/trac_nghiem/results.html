{% extends 'layouts/admin.html' %}

{% block title %}Kết Quả Quiz{% endblock %}

{% block extra_css %}
<style>
.result-table th {
    background: #FFC107;
    color: #000;
}
.hover-row:hover {
    background: #FFF8E1;
}
.badge-passed {
    background: #28a745;
    color: #fff;
}
.badge-failed {
    background: #dc3545;
    color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4"><i class="bi bi-clipboard-data me-2"></i> Kết Quả Ứng Viên</h2>

    <!-- Filter Form -->
    <form method="GET" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <select name="quiz_id" class="form-select">
                    <option value="">Tất cả Quiz</option>
                    {% for q in quizzes %}
                    <option value="{{ q.id }}" {% if request.args.get('quiz_id')|int == q.id %}selected{% endif %}>{{ q.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" name="search" class="form-control" placeholder="Tìm tên/email..." value="{{ request.args.get('search', '') }}">
            </div>
            <div class="col-md-2">
                <select name="status" class="form-select">
                    <option value="">Tất cả Trạng Thái</option>
                    <option value="passed" {% if request.args.get('status') == 'passed' %}selected{% endif %}>Đạt</option>
                    <option value="failed" {% if request.args.get('status') == 'failed' %}selected{% endif %}>Chưa Đạt</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Lọc</button>
            </div>
        </div>
    </form>

    <!-- Table Results -->
    <div class="card">
        <div class="card-body p-0">
            <table class="table result-table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên Ứng Viên</th>
                        <th>Email</th>
                        <th>Quiz</th>
                        <th>Điểm</th>
                        <th>Trạng Thái</th>
                        <th>Thời Gian Làm</th>
                        <th>Ngày Làm</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attempt in attempts.items %}
                    <tr class="hover-row">
                        <td>{{ attempt.id }}</td>
                        <td>{{ attempt.user_name }}</td>
                        <td>{{ attempt.user_email or 'N/A' }}</td>
                        <td>{{ attempt.quiz.title }}</td>
                        <td>{{ attempt.score }}</td>
                        <td>
                            {% if attempt.passed %}
                            <span class="badge badge-passed">Đạt</span>
                            {% else %}
                            <span class="badge badge-failed">Chưa Đạt</span>
                            {% endif %}
                        </td>
                        <td>{{ attempt.get_time_spent_formatted() }}</td>
                        <td>{{ attempt.completed_at|vn_datetime_friendly }}</td>
                        <td>
                            <a href="{{ url_for('admin.view_result', attempt_id=attempt.id) }}"
                               class="btn btn-sm btn-info">
                                <i class="bi bi-eye"></i> Chi Tiết
                            </a>

                            <form method="POST"
                                  action="{{ url_for('admin.delete_attempt', attempt_id=attempt.id) }}"
                                  style="display:inline;"
                                  onsubmit="return confirm('Bạn có chắc chắn muốn xóa kết quả này không?');">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Xóa
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">Chưa có kết quả nào</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if attempts.has_next or attempts.has_prev %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            {% if attempts.has_prev %}
            <li class="page-item"><a class="page-link" href="?page={{ attempts.prev_num }}">Trước</a></li>
            {% endif %}
            <li class="page-item disabled"><a class="page-link">Trang {{ attempts.page }} / {{ attempts.pages }}</a></li>
            {% if attempts.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ attempts.next_num }}">Sau</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}