{% extends 'layouts/admin.html' %}

{% block title %}Qu·∫£n l√Ω Quiz{% endblock %}

{% block extra_css %}
<style>
/* Custom style cho table quiz */
.table-quiz {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.table-quiz th {
    background: #FFC107; /* M√†u v√†ng t·ª´ theme */
    color: #000;
    font-weight: 600;
}
.table-quiz td {
    vertical-align: middle;
}
.hover-row:hover {
    background: #FFF8E1;
    transform: translateY(-2px);
    transition: all 0.2s ease;
}
.badge-active {
    background: #28a745;
    color: #fff;
}
.badge-inactive {
    background: #dc3545;
    color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-card-list me-2"></i> Qu·∫£n l√Ω Test</h2>
        <a href="{{ url_for('admin.add_quiz') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Th√™m Quiz M·ªõi
        </a>
    </div>

    <!-- ‚ú® QR_CACHE: Search Form (gi·ªØ nguy√™n) -->
    <form method="GET" class="mb-4">
        <div class="input-group">
            <input type="text" name="search" class="form-control" placeholder="T√¨m theo t√™n quiz..." value="{{ request.args.get('search', '') }}">
            <button type="submit" class="btn btn-outline-secondary"><i class="bi bi-search"></i></button>
        </div>
    </form>

    <!-- Table Quiz -->
    <div class="card">
        <div class="card-body p-0">
            <table class="table table-quiz table-hover mb-0">
                <thead>
                    <tr>
                        <th>T√™n Quiz</th>
                        <th>S·ªë C√¢u H·ªèi</th>
                        <th>Th·ªùi Gian (Ph√∫t)</th>
                        <th>ƒêi·ªÉm ƒê·∫°t (%)</th>
                        <th>L∆∞·ª£t L√†m</th>
                        <th>T·ª∑ L·ªá ƒê·∫°t (%)</th>
                        <th>ƒêi·ªÉm TB</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in quiz_stats %}
                    {% set quiz = stat.quiz %}
                    <tr class="hover-row">
                        <td>{{ quiz.title }}</td>
                        <td>{{ stat.total_questions }}</td>
                        <td>{{ quiz.duration_minutes }}</td>
                        <td>{{ quiz.pass_score }}</td>
                        <td>{{ stat.total_attempts }}</td>
                        <td>{{ stat.pass_rate }}%</td>
                        <td>{{ stat.avg_score }}</td>
                        <td>
                            {% if quiz.is_active %}
                            <span class="badge badge-active">Active</span>
                            {% else %}
                            <span class="badge badge-inactive">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.edit_quiz', id=quiz.id) }}" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i>
                            </a>

                            <a href="{{ url_for('admin.edit_questions', quiz_id=quiz.id) }}" class="btn btn-sm btn-info">
                                <i class="bi bi-question-circle"></i>
                            </a>

                            <!-- ‚ú® QR_CACHE: N√∫t xem QR - KH√îNG T·∫†O QR M·ªöI N·ªÆA -->
                            <!-- Ch·ªâ g·ªçi h√†m pass d·ªØ li·ªáu (QR t·ª´ DB + link) -->
                            <button class="btn btn-sm btn-success"
                                    onclick="showSurveyModal('{{ quiz.get_qr_code_data_url() }}', '{{ quiz.title|escape }}', '{{ url_for('main.quiz_take', slug=quiz.slug, _external=True) }}')">
                                <i class="bi bi-eye"></i>
                            </button>

                            <a href="{{ url_for('admin.delete_quiz', id=quiz.id) }}" class="btn btn-sm btn-danger"
                               onclick="return confirm('X√°c nh·∫≠n x√≥a?')">
                               <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">Ch∆∞a c√≥ quiz n√†o</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination (gi·ªØ nguy√™n) -->
    {% if quizzes.has_next or quizzes.has_prev %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center">
            {% if quizzes.has_prev %}
            <li class="page-item"><a class="page-link" href="?page={{ quizzes.prev_num }}">Tr∆∞·ªõc</a></li>
            {% endif %}
            <li class="page-item disabled"><a class="page-link">Trang {{ quizzes.page }} / {{ quizzes.pages }}</a></li>
            {% if quizzes.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ quizzes.next_num }}">Sau</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- ‚ú® QR_CACHE: Modal - Hi·ªÉn th·ªã QR ƒë√£ l∆∞u (KH√îNG T·∫†O QR M·ªöI) -->
<div class="modal fade" id="surveyModal" tabindex="-1" aria-labelledby="surveyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="surveyModalLabel">üîó Li√™n k·∫øt b√†i kh·∫£o s√°t</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <!-- ‚ú® QR_CACHE: Hi·ªÉn th·ªã QR t·ª´ Base64 (DB) thay v√¨ t·∫°o JS -->
        <div class="mb-3 d-flex justify-content-center">
          <img id="qrImg" src="" alt="QR Code" style="max-width: 200px; border: 1px solid #ddd; padding: 10px;">
        </div>
        <p class="fw-bold">Link b√†i kh·∫£o s√°t:</p>
        <div class="input-group mb-3">
          <input type="text" id="surveyLink" class="form-control" readonly>
          <button class="btn btn-outline-secondary" type="button" onclick="copySurveyLink()">Copy</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
function showSurveyModal(qrDataUrl, title, link) {
    const modal = new bootstrap.Modal(document.getElementById('surveyModal'));
    const qrImg = document.getElementById('qrImg');
    const linkInput = document.getElementById('surveyLink');

    // ‚ú® QR_CACHE: G√°n QR t·ª´ database (data URL)
    qrImg.src = qrDataUrl;

    // G√°n link
    linkInput.value = link;

    modal.show();
}

/**
 * ‚ú® QR_CACHE: Copy link (gi·ªØ nguy√™n)
 */
function copySurveyLink() {
    const input = document.getElementById('surveyLink');
    input.select();
    input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value);
    alert("‚úÖ ƒê√£ sao ch√©p link kh·∫£o s√°t!");
}
</script>
{% endblock %}
{% endblock %}