{% extends 'layouts/admin.html' %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-newspaper"></i> {{ title }}</h4>
    <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="blogForm">
                    {{ form.hidden_tag() }}

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Ti√™u ƒë·ªÅ b√†i vi·∫øt *</label>
                            {{ form.title(class="form-control", id="blogTitle", placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt") }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Slug (URL) *</label>
                            {{ form.slug(class="form-control", id="blogSlug", placeholder="tieu-de-bai-viet") }}
                            {% if form.slug.errors %}
                                <div class="text-danger small mt-1">{{ form.slug.errors[0] }}</div>
                            {% endif %}
                            <small class="text-muted">T·ª± ƒë·ªông t·ª´ ti√™u ƒë·ªÅ</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">M√¥ t·∫£ ng·∫Øn (Excerpt)</label>
                            {{ form.excerpt(class="form-control", id="blogExcerpt", rows="3", placeholder="T√≥m t·∫Øt n·ªôi dung b√†i vi·∫øt") }}
                            <small class="text-muted">T·ªëi ƒëa 200 k√Ω t·ª±</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">N·ªôi dung b√†i vi·∫øt *</label>
                            {{ form.content(class="form-control", id="editor", rows="15", placeholder="Vi·∫øt n·ªôi dung ƒë·∫ßy ƒë·ªß ·ªü ƒë√¢y...") }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">H√¨nh ·∫£nh ƒë·∫°i di·ªán</label>
                            <div class="input-group">
                                {{ form.image(class="form-control", id="image") }}
                                <button type="button" class="btn btn-warning" onclick="openMediaPicker('image', 'imagePreview')">
                                    <i class="bi bi-images"></i> Ch·ªçn t·ª´ th∆∞ vi·ªán
                                </button>
                            </div>
                            <small class="text-muted">Khuy·∫øn ngh·ªã: 800x500px (Max 16MB)</small>

                            <input type="hidden" name="selected_image_path" id="selectedImagePath" value="">

                            <div class="mt-2">
                                <img id="imagePreview" src="{% if blog and blog.image %}{{ blog.image }}{% endif %}" alt="Preview" class="img-thumbnail" style="max-height: 150px; {% if not blog or not blog.image %}display: none;{% endif %}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">T√°c gi·∫£</label>
                            {{ form.author(class="form-control", placeholder="T√™n t√°c gi·∫£") }}
                            <small class="text-muted">ƒê·ªÉ tr·ªëng s·∫Ω l·∫•y t√™n user hi·ªán t·∫°i</small>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_featured(class="form-check-input") }}
                                <label class="form-check-label" for="{{ form.is_featured.id }}">
                                    <i class="bi bi-star"></i> ƒê√°nh d·∫•u l√† b√†i vi·∫øt n·ªïi b·∫≠t
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_active(class="form-check-input", checked=true) }}
                                <label class="form-check-label" for="{{ form.is_active.id }}">
                                    K√≠ch ho·∫°t hi·ªÉn th·ªã
                                </label>
                            </div>
                        </div>

                        <div class="col-12 mt-4">
                            {{ form.submit(class="btn btn-warning px-5") }}
                            <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">H·ªßy</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'components/media_picker.html' %}
{% endblock %}
{% block extra_js %}
<script>
// Auto-generate slug from title
document.querySelector('input[name="title"]').addEventListener('input', function(e) {
    const slug = e.target.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ƒë/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    document.querySelector('input[name="slug"]').value = slug;
});
</script>

<!-- ==================== CKEDITOR 5 V·ªöI RESIZE ·∫¢NH B·∫∞NG CHU·ªòT ==================== -->
<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />

<script>
const {
    ClassicEditor,
    Essentials,
    Bold,
    Italic,
    Underline,
    Strikethrough,
    Font,
    Paragraph,
    Heading,
    Link,
    List,
    Image,
    ImageCaption,
    ImageStyle,
    ImageToolbar,
    ImageUpload,
    ImageResize,
    LinkImage,
    Table,
    TableToolbar,
    BlockQuote,
    Code,
    Alignment,
    Undo
} = CKEDITOR;

let editorInstance;

// ‚úÖ CUSTOM UPLOAD ADAPTER CLASS
class MyUploadAdapter {
    constructor(loader) {
        this.loader = loader;
    }

    upload() {
        return this.loader.file.then(file => {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('upload', file);

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                console.log('üöÄ Starting upload:', file.name);

                fetch('{{ url_for("admin.ckeditor_upload_image") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log('üì° Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üì¶ Response data:', data);

                    if (data.url) {
                        console.log('‚úÖ Upload success:', data.url);
                        resolve({ default: data.url });
                    } else if (data.error) {
                        console.error('‚ùå Upload error:', data.error.message);
                        reject(data.error.message);
                    } else {
                        console.error('‚ùå Unknown response format');
                        reject('Upload th·∫•t b·∫°i');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Network error:', error);
                    reject('L·ªói k·∫øt n·ªëi: ' + error.message);
                });
            });
        });
    }

    abort() {
        console.log('‚ö†Ô∏è Upload aborted');
    }
}

// ‚úÖ PLUGIN ƒê·ªÇ ƒêƒÇNG K√ù UPLOAD ADAPTER
function MyCustomUploadAdapterPlugin(editor) {
    editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
        console.log('üîå Creating upload adapter');
        return new MyUploadAdapter(loader);
    };
}

// ‚úÖ KH·ªûI T·∫†O CKEDITOR 5
ClassicEditor
    .create(document.querySelector('#editor'), {
        plugins: [
            Essentials,
            Bold, Italic, Underline, Strikethrough,
            Font,
            Paragraph, Heading,
            Link, List,
            Image, ImageCaption, ImageStyle, ImageToolbar, ImageUpload, ImageResize, LinkImage,
            Table, TableToolbar,
            BlockQuote, Code,
            Alignment,
            Undo,
            MyCustomUploadAdapterPlugin
        ],

        toolbar: {
            items: [
                'heading', '|',
                'bold', 'italic', 'underline', 'strikethrough', '|',
                'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                'link', 'bulletedList', 'numberedList', '|',
                'uploadImage', 'insertTable', 'blockQuote', 'code', '|',
                'alignment', '|',
                'undo', 'redo'
            ],
            shouldNotGroupWhenFull: true
        },

        image: {
            toolbar: [
                'imageStyle:inline',
                'imageStyle:wrapText',
                'imageStyle:breakText',
                '|',
                'toggleImageCaption',
                '|',
                'imageTextAlternative',
                '|',
                'linkImage'
            ],
            styles: [
                'full',
                'alignLeft',
                'alignCenter',
                'alignRight'
            ],
            upload: {
                types: ['jpeg', 'png', 'gif', 'webp', 'jpg']
            }
        },

        fontSize: {
            options: [
                'tiny',
                'small',
                'default',
                'big',
                'huge'
            ]
        },

        alignment: {
            options: ['left', 'center', 'right', 'justify']
        },

        table: {
            contentToolbar: [
                'tableColumn', 'tableRow', 'mergeTableCells',
                'tableProperties', 'tableCellProperties'
            ]
        },

        link: {
            decorators: {
                openInNewTab: {
                    mode: 'manual',
                    label: 'M·ªü tab m·ªõi',
                    attributes: {
                        target: '_blank',
                        rel: 'noopener noreferrer'
                    }
                }
            }
        }
    })
    .then(editor => {
        console.log('‚úÖ CKEditor 5 v·ªõi ImageResize kh·ªüi t·∫°o th√†nh c√¥ng!');
        editorInstance = editor;
        const textarea = document.querySelector('#editor');
        textarea.removeAttribute('required');

        // Submit form handler
        document.querySelector('form').addEventListener('submit', function(e) {
            const content = editorInstance.getData().trim();
            textarea.value = content;
            if (!content) {
                e.preventDefault();
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt');
                editorInstance.focus();
                return false;
            }
        });
    })
    .catch(error => {
        console.error('‚ùå L·ªói kh·ªüi t·∫°o CKEditor:', error);
        alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o tr√¨nh so·∫°n th·∫£o. Vui l√≤ng refresh trang.');
    });
</script>

<!-- ‚úÖ CSS ƒê·ªÇ ·∫¢NH RESPONSIVE -->
<style>
.ck-content img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
}

.ck-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ck-content figure.image {
    margin: 1em 0;
}

.ck-content figure.image img {
    margin: 0 auto;
}

.ck-content figure.image figcaption {
    text-align: center;
    font-style: italic;
    color: #666;
    padding: 0.5em;
    background: #f5f5f5;
    margin-top: 0.5em;
}

.ck-content .image-style-align-left,
.ck-content .image-style-side {
    float: left;
    margin-right: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-right {
    float: right;
    margin-left: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-center {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
</style>

<!-- ‚úÖ TH√äM CSS ƒê·ªÇ ·∫¢NH RESPONSIVE TR√äN FRONTEND -->
<style>
/* CSS cho ·∫£nh trong CKEditor */
.ck-content img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
}

.ck-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* CSS cho figure (·∫£nh c√≥ caption) */
.ck-content figure.image {
    margin: 1em 0;
}

.ck-content figure.image img {
    margin: 0 auto;
}

.ck-content figure.image figcaption {
    text-align: center;
    font-style: italic;
    color: #666;
    padding: 0.5em;
    background: #f5f5f5;
    margin-top: 0.5em;
}

/* CSS cho ·∫£nh cƒÉn tr√°i/ph·∫£i */
.ck-content .image-style-align-left,
.ck-content .image-style-side {
    float: left;
    margin-right: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-right {
    float: right;
    margin-left: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-center {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
</style>

{% endblock %}