{% extends 'layouts/admin.html' %}

{% block page_title %}Upload Media{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-cloud-upload"></i> Upload Media Files</h4>
    <a href="{{ url_for('admin.media') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay lại Media Library
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-4">
                        <label class="form-label">Chọn file *</label>
                        <input type="file"
                               name="files"
                               class="form-control"
                               multiple
                               accept="image/*"
                               id="fileInput"
                               required>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Chọn nhiều file cùng lúc (JPG, PNG, GIF, WebP). Max 16MB/file
                        </small>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Loại thư mục</label>
                            <select name="folder" class="form-select">
                                <option value="general">Chung</option>
                                <option value="banners">Banner</option>
                                <option value="products">Sản phẩm</option>
                                <option value="blogs">Blog</option>
                                <option value="categories">Danh mục</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Album (tùy chọn)</label>
                            <input type="text"
                                   name="album"
                                   class="form-control"
                                   list="albumList"
                                   placeholder="Chọn hoặc nhập tên album mới">
                            <datalist id="albumList">
                                {% for album in albums %}
                                <option value="{{ album.name }}">
                                {% endfor %}
                            </datalist>
                            <small class="text-muted">
                                Không sử dụng dấu - để trống nếu không phân loại
                            </small>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div id="previewArea" class="mb-4"></div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" style="display: none;" class="mb-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 0%"
                                 id="progressBar">0%</div>
                        </div>
                        <p class="small text-center mt-2" id="uploadStatus">Đang upload...</p>
                    </div>

                    <button type="submit" class="btn btn-warning btn-lg px-5" id="submitBtn">
                        <i class="bi bi-cloud-upload"></i> Upload Files
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar: Hướng dẫn -->
    <div class="col-lg-4">
        <div class="card mb-3 border-warning">
            <div class="card-header bg-warning">
                <h6 class="mb-0"><i class="bi bi-image"></i> Kích thước ảnh tối ưu</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tbody>
                        <tr>
                            <td><strong>Banner Slider Pc</strong></td>
                            <td class="text-end">1920×600px</td>
                        </tr>
                        <tr>
                            <td><strong>Banner Slider ĐT</strong></td>
                            <td class="text-end">1080x1080</td>
                        </tr>
                        <tr>
                            <td><strong>Sản phẩm</strong></td>
                            <td class="text-end">800×531px</td>
                        </tr>
                        <tr>
                            <td><strong>Tin tức</strong></td>
                            <td class="text-end">1200×630px</td>
                        </tr>
                        <tr>
                            <td><strong>Dự án</strong></td>
                            <td class="text-end">1200×480 - tỉ lệ 5:2 hoặc 3:1</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info small mt-3 mb-0">
                    <i class="bi bi-gear"></i> Vui lòng Upload kích thước ảnh đúng!
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Preview images before upload
document.getElementById('fileInput').addEventListener('change', function(e) {
    const previewArea = document.getElementById('previewArea');
    previewArea.innerHTML = '<h6 class="mb-3"><i class="bi bi-eye"></i> Preview:</h6><div class="row g-2" id="previews"></div>';

    const files = Array.from(e.target.files);
    const previewsContainer = document.getElementById('previews');

    files.forEach((file, index) => {
        if (file.type.startsWith('image/')) {
            // Validate file size
            const maxSize = 16 * 1024 * 1024; // 16MB
            if (file.size > maxSize) {
                alert(`File "${file.name}" quá lớn! Max 16MB`);
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                col.innerHTML = `
                    <div class="card border">
                        <div class="row g-0">
                            <div class="col-4">
                                <img src="${e.target.result}"
                                     class="img-fluid rounded-start"
                                     style="height: 120px; width: 100%; object-fit: cover;">
                            </div>
                            <div class="col-8">
                                <div class="card-body p-2">
                                    <p class="small mb-1 text-truncate fw-bold" title="${file.name}">
                                        ${file.name}
                                    </p>
                                    <p class="small text-muted mb-0">
                                        <i class="bi bi-file-earmark"></i> ${(file.size / 1024).toFixed(1)} KB
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                previewsContainer.appendChild(col);
            };

            reader.readAsDataURL(file);
        }
    });
});

// Form validation and submission
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const files = document.getElementById('fileInput').files;

    if (files.length === 0) {
        e.preventDefault();
        alert('Vui lòng chọn ít nhất 1 file!');
        return false;
    }

    // Show progress
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;

    // Simulate progress
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const interval = setInterval(() => {
        progress += 10;
        if (progress <= 90) {
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
        }
    }, 200);

    setTimeout(() => clearInterval(interval), 3000);
});

// Album input: chỉ cho phép không dấu và space -> _
const albumInput = document.querySelector('input[name="album"]');
if (albumInput) {
    albumInput.addEventListener('input', function() {
        let val = albumInput.value;
        val = val.toLowerCase();
        val = val.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        val = val.replace(/\s+/g, '_');
        val = val.replace(/[^a-z0-9_]/g, '');
        albumInput.value = val;
    });
}
</script>
{% endblock %}