{% extends 'layouts/clone.html' %}

{% block title %}Kết quả - {{ quiz.title }}{% endblock %}

{% block extra_css %}
<style>
/* ==================== RESULT CONTAINER ==================== */
.result-container {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
}

/* ==================== RESULT CARD ==================== */
.result-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

/* ==================== STATS GRID ==================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
    padding: 2rem;
    background: #f8f9fa;
    align-items: stretch;
    text-align: center;
}

.stat-item {
    background: #fff;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
}

/* ==================== REVIEW SECTION ==================== */
.review-section {
    padding: 2rem;
}

.review-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.question-review {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #28a745;
}

.question-review.wrong {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.question-review-header {
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
}

.question-review-text {
    font-size: 1.05rem;
    color: #222;
    margin-bottom: 1rem;
    font-weight: 500;
}

.answer-review {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.answer-review.correct {
    background: #d4edda;
    border: 2px solid #28a745;
}

.answer-review.wrong {
    background: #f8d7da;
    border: 2px solid #dc3545;
}

.answer-review.neutral {
    background: #fff;
    border: 2px solid #e0e0e0;
}

.answer-icon {
    font-size: 1.2rem;
    font-weight: 700;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

/* ==================== PRINT STYLES ==================== */
@media print {
    .navbar,
    footer {
        display: none !important;
    }

    .result-container {
        max-width: 100%;
    }

    .question-review {
        page-break-inside: avoid;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="result-container">
    <!-- Result Card -->
    <div class="result-card">
        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Tổng câu hỏi</div>
                <div class="stat-value">{{ attempt.total_questions }}</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">Câu trả lời đúng</div>
                <div class="stat-value text-success">{{ attempt.correct_answers }}</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">Câu trả lời sai</div>
                <div class="stat-value text-danger">{{ attempt.wrong_answers }}</div>
            </div>

            <div class="stat-item">
                <div class="stat-label">Thời gian làm bài</div>
                <div class="stat-value">{{ attempt.get_time_spent_formatted() }}</div>
            </div>
        </div>

        {% if quiz.show_correct_answers %}
        <!-- Review Section -->
        <div class="review-section">
          <h3 class="review-title">
              <i class="bi bi-clipboard-check"></i> Chi tiết đáp án
          </h3>

          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="reviewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#tab-correct">Câu đúng</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#tab-wrong"> Câu sai</a>
            </li>
          </ul>

        <div class="tab-content">
          <!-- CÂU ĐÚNG -->
          <div class="tab-pane fade show active" id="tab-correct">
            {% set correct_questions = questions_detail|selectattr('is_correct', 'equalto', True)|list %}
            {% if correct_questions %}
              {% for item in correct_questions %}
                <div class="question-review">
                  <div class="question-review-header">
                    <span class="text-success">Đúng</span> - Câu {{ loop.index }}
                  </div>
                  <div class="question-review-text">{{ item.question.question_text }}</div>
                  <div class="answer-review correct">
                    <strong>Câu trả lời của bạn:</strong> {{ item.selected_answer.answer_text }}
                  </div>
                  {% if item.question.explanation %}
                  <div class="mt-3 p-3 bg-light rounded">
                    <strong class="text-info"><i class="bi bi-lightbulb"></i> Giải thích:</strong>
                    <p class="mb-0 mt-2">{{ item.question.explanation }}</p>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">Không có câu nào đúng.</p>
            {% endif %}
          </div>

          <!-- CÂU SAI -->
          <div class="tab-pane fade" id="tab-wrong">
            {% set wrong_questions = questions_detail|rejectattr('is_correct', 'equalto', True)|list %}
            {% if wrong_questions %}
              {% for item in wrong_questions %}
                <div class="question-review wrong">
                  <div class="question-review-header">
                    <span class="text-danger">Sai</span> - Câu {{ loop.index }}
                  </div>
                  <div class="question-review-text">{{ item.question.question_text }}</div>
                  <div class="answer-review wrong">
                    <strong>Câu trả lời của bạn:</strong> {{ item.selected_answer.answer_text }}
                  </div>
                  <div class="answer-review correct">
                    <strong>Đáp án đúng:</strong> {{ item.correct_answer.answer_text }}
                  </div>
                  {% if item.question.explanation %}
                  <div class="mt-3 p-3 bg-light rounded">
                    <strong class="text-info"><i class="bi bi-lightbulb"></i> Giải thích:</strong>
                    <p class="mb-0 mt-2">{{ item.question.explanation }}</p>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">Không có câu nào sai.</p>
            {% endif %}
          </div>
        </div>

        <!-- PHÂN TRANG -->
        <nav id="paginationContainer" class="mt-4 text-center"></nav>
      </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const perPage = 5;
  const tabs = document.querySelectorAll('#reviewTabs a');

  tabs.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (e) {
      setupPagination(e.target.getAttribute('href'));
    });
  });

  setupPagination('#tab-correct');

  function setupPagination(tabId) {
    const container = document.querySelector(tabId);
    const reviews = container.querySelectorAll('.question-review');
    const pagination = document.getElementById('paginationContainer');
    pagination.innerHTML = '';

    if (reviews.length <= perPage) {
      reviews.forEach(el => el.style.display = '');
      return;
    }

    let currentPage = 1;
    const totalPages = Math.ceil(reviews.length / perPage);

    function showPage(page) {
      reviews.forEach((el, i) => {
        el.style.display = (i >= (page - 1) * perPage && i < page * perPage) ? '' : 'none';
      });

      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'btn btn-sm ' + (i === page ? 'btn-primary' : 'btn-outline-primary');
        btn.style.margin = '0 4px';
        btn.onclick = () => showPage(i);
        pagination.appendChild(btn);
      }
    }

    showPage(currentPage);
  }
});

// Ngăn chặn quay lại trang trước
history.pushState(null, null, window.location.href);
window.onpopstate = function () {
  history.pushState(null, null, window.location.href);
};
</script>
{% endblock %}