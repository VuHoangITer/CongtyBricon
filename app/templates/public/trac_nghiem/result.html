{% extends 'layouts/base.html' %}

{% block title %}K·∫øt qu·∫£ - {{ quiz.title }}{% endblock %}

{% block extra_css %}
<style>
/* ==================== RESULT CONTAINER ==================== */
.result-container {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
}

/* ==================== RESULT CARD ==================== */
.result-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

.result-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: #fff;
    padding: 2rem;
    text-align: center;
}

.result-header.failed {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.result-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.result-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
}

/* ==================== SCORE DISPLAY ==================== */
.score-display {
    padding: 2rem;
    text-align: center;
    background: linear-gradient(to bottom, #f8f9fa, #fff);
}

.score-circle {
    width: 200px;
    height: 200px;
    margin: 0 auto 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: #fff;
    box-shadow: 0 0 0 10px rgba(40, 167, 69, 0.1);
}

.score-circle.failed {
    box-shadow: 0 0 0 10px rgba(220, 53, 69, 0.1);
}

.score-value {
    font-size: 4rem;
    font-weight: 700;
    color: #28a745;
}

.score-value.failed {
    color: #dc3545;
}

.score-label {
    font-size: 1.2rem;
    color: #666;
    margin-top: 0.5rem;
}

/* ==================== STATS GRID ==================== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* Lu√¥n 4 c·ªôt ƒë·ªÅu nhau */
    gap: 1.5rem;
    padding: 2rem;
    background: #f8f9fa;
    align-items: stretch;
    text-align: center;
}


.stat-item {
    background: #fff;
    padding: 1.5rem;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
}

/* ==================== STATUS BADGE ==================== */
.status-badge {
    display: inline-block;
    padding: 0.75rem 2rem;
    border-radius: 50px;
    font-size: 1.1rem;
    font-weight: 700;
    margin: 1rem 0;
}

.status-badge.passed {
    background: #d4edda;
    color: #155724;
    border: 2px solid #28a745;
}

.status-badge.failed {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #dc3545;
}

/* ==================== REVIEW SECTION ==================== */
.review-section {
    padding: 2rem;
}

.review-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
}

.question-review {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border-left: 4px solid #28a745;
}

.question-review.wrong {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.question-review-header {
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
}

.question-review-text {
    font-size: 1.05rem;
    color: #222;
    margin-bottom: 1rem;
    font-weight: 500;
}

.answer-review {
    padding: 0.75rem 1rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.answer-review.correct {
    background: #d4edda;
    border: 2px solid #28a745;
}

.answer-review.wrong {
    background: #f8d7da;
    border: 2px solid #dc3545;
}

.answer-review.neutral {
    background: #fff;
    border: 2px solid #e0e0e0;
}

.answer-icon {
    font-size: 1.2rem;
    font-weight: 700;
}

/* ==================== ACTION BUTTONS ==================== */
.action-buttons {
    display: flex;
    gap: 1rem;
    padding: 2rem;
    flex-wrap: wrap;
}

.action-btn {
    flex: 1;
    min-width: 200px;
    padding: 1rem 2rem;
    font-weight: 600;
    border-radius: 10px;
    font-size: 1.05rem;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .result-title {
        font-size: 1.5rem;
    }
    
    .score-circle {
        width: 150px;
        height: 150px;
    }
    
    .score-value {
        font-size: 3rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="result-container">
    <!-- Result Card -->
    <div class="result-card">
        <!-- Header -->
        <div class="result-header {% if not attempt.passed %}failed{% endif %}">
            <div class="result-title">
                {% if attempt.passed %}
                    B·∫†N ƒê√É ƒê·∫†T!
                {% else %}
                    B·∫†N CH∆ØA ƒê·∫†T!
                {% endif %}
            </div>
            <div class="result-subtitle">{{ quiz.title }}</div>
        </div>

        <!-- Score Display -->
        <div class="score-display">
          <div class="score-circle {% if not attempt.passed %}failed{% endif %}">
              <div>
                  <div class="score-value {% if not attempt.passed %}failed{% endif %}">
                      {{ "%.0f"|format(attempt.score) }}%
                  </div>
                  <div class="text-center">
                      <small class="text-muted">ph·∫ßn trƒÉm ƒë√∫ng</small>
                  </div>
              </div>
          </div>


            <div class="status-badge {% if attempt.passed %}passed{% else %}failed{% endif %}">
                {% if attempt.passed %}
                    ‚úì ƒê·∫†T Y√äU C·∫¶U ({{ quiz.pass_score }}%)
                {% else %}
                    ‚úó CH∆ØA ƒê·∫†T (C·∫ßn {{ quiz.pass_score }}%)
                {% endif %}
            </div>

            <p class="text-muted mt-3">
                Ng∆∞·ªùi l√†m b√†i: <strong>{{ attempt.user_name }}</strong>
                {% if attempt.user_email %}
                    <br>Email: {{ attempt.user_email }}
                {% endif %}
            </p>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-icon">üìù</div>
                <div class="stat-value">{{ attempt.total_questions }}</div>
                <div class="stat-label">T·ªïng c√¢u h·ªèi</div>
            </div>

            <div class="stat-item">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value text-success">{{ attempt.correct_answers }}</div>
                <div class="stat-label">C√¢u tr·∫£ l·ªùi ƒë√∫ng</div>
            </div>

            <div class="stat-item">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-value text-danger">{{ attempt.wrong_answers }}</div>
                <div class="stat-label">C√¢u tr·∫£ l·ªùi sai</div>
            </div>

            <div class="stat-item">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value">{{ attempt.get_time_spent_formatted() }}</div>
                <div class="stat-label">Th·ªùi gian l√†m b√†i</div>
            </div>
        </div>

        {% if quiz.show_correct_answers %}
        <!-- Review Section -->
        <div class="review-section">
          <h3 class="review-title">
              <i class="bi bi-clipboard-check"></i> Chi ti·∫øt ƒë√°p √°n
          </h3>

          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="reviewTabs">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#tab-correct">‚úÖ C√¢u ƒë√∫ng</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#tab-wrong">‚ùå C√¢u sai</a>
            </li>
          </ul>

        <div class="tab-content">
          <!-- C√ÇU ƒê√öNG -->
          <div class="tab-pane fade show active" id="tab-correct">
            {% set correct_questions = questions_detail|selectattr('is_correct', 'equalto', True)|list %}
            {% if correct_questions %}
              {% for item in correct_questions %}
                <div class="question-review">
                  <div class="question-review-header">
                    <span class="text-success">‚úì ƒê√∫ng</span> - C√¢u {{ loop.index }}
                  </div>
                  <div class="question-review-text">{{ item.question.question_text }}</div>
                  <div class="answer-review correct">
                    <span class="answer-icon">‚úì</span>
                    <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> {{ item.selected_answer.answer_text }}
                  </div>
                  {% if item.question.explanation %}
                  <div class="mt-3 p-3 bg-light rounded">
                    <strong class="text-info"><i class="bi bi-lightbulb"></i> Gi·∫£i th√≠ch:</strong>
                    <p class="mb-0 mt-2">{{ item.question.explanation }}</p>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">Kh√¥ng c√≥ c√¢u n√†o ƒë√∫ng.</p>
            {% endif %}
          </div>

          <!-- C√ÇU SAI -->
          <div class="tab-pane fade" id="tab-wrong">
            {% set wrong_questions = questions_detail|rejectattr('is_correct', 'equalto', True)|list %}
            {% if wrong_questions %}
              {% for item in wrong_questions %}
                <div class="question-review wrong">
                  <div class="question-review-header">
                    <span class="text-danger">‚úó Sai</span> - C√¢u {{ loop.index }}
                  </div>
                  <div class="question-review-text">{{ item.question.question_text }}</div>
                  <div class="answer-review wrong">
                    <span class="answer-icon">‚úó</span>
                    <strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> {{ item.selected_answer.answer_text }}
                  </div>
                  <div class="answer-review correct">
                    <span class="answer-icon">‚úì</span>
                    <strong>ƒê√°p √°n ƒë√∫ng:</strong> {{ item.correct_answer.answer_text }}
                  </div>
                  {% if item.question.explanation %}
                  <div class="mt-3 p-3 bg-light rounded">
                    <strong class="text-info"><i class="bi bi-lightbulb"></i> Gi·∫£i th√≠ch:</strong>
                    <p class="mb-0 mt-2">{{ item.question.explanation }}</p>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">Kh√¥ng c√≥ c√¢u n√†o sai.</p>
            {% endif %}
          </div>
        </div>

        <!-- PH√ÇN TRANG (n·∫øu nhi·ªÅu h∆°n 5 c√¢u) -->
        <nav id="paginationContainer" class="mt-4 text-center"></nav>
      </div>
        {% endif %}
    </div>
</div>

<style>
/* Print styles */
@media print {
    .action-buttons,
    .navbar,
    footer {
        display: none !important;
    }
    
    .result-container {
        max-width: 100%;
    }
    
    .question-review {
        page-break-inside: avoid;
    }
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const perPage = 5;
  const tabs = document.querySelectorAll('#reviewTabs a');

  tabs.forEach(tab => {
    tab.addEventListener('shown.bs.tab', function (e) {
      setupPagination(e.target.getAttribute('href'));
    });
  });

  setupPagination('#tab-correct');

  function setupPagination(tabId) {
    const container = document.querySelector(tabId);
    const reviews = container.querySelectorAll('.question-review');
    const pagination = document.getElementById('paginationContainer');
    pagination.innerHTML = '';

    if (reviews.length <= perPage) {
      reviews.forEach(el => el.style.display = '');
      return;
    }

    let currentPage = 1;
    const totalPages = Math.ceil(reviews.length / perPage);

    function showPage(page) {
      reviews.forEach((el, i) => {
        el.style.display = (i >= (page - 1) * perPage && i < page * perPage) ? '' : 'none';
      });

      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'btn btn-sm ' + (i === page ? 'btn-primary' : 'btn-outline-primary');
        btn.style.margin = '0 4px';
        btn.onclick = () => showPage(i);
        pagination.appendChild(btn);
      }
    }

    showPage(currentPage);
  }
});
  // NgƒÉn ch·∫∑n quay l·∫°i trang tr∆∞·ªõc
  history.pushState(null, null, window.location.href);
  window.onpopstate = function () {
    history.pushState(null, null, window.location.href);
  };
</script>
{% endblock %}